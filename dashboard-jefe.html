<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Jefe - REG Marketing</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="database.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .kpi-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-top: 4px solid;
        }
        
        .kpi-box.blue { border-top-color: #2196F3; }
        .kpi-box.orange { border-top-color: #FF9800; }
        .kpi-box.green { border-top-color: #4CAF50; }
        .kpi-box.purple { border-top-color: #9C27B0; }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .kpi-box.blue .kpi-value { color: #2196F3; }
        .kpi-box.orange .kpi-value { color: #FF9800; }
        .kpi-box.green .kpi-value { color: #4CAF50; }
        .kpi-box.purple .kpi-value { color: #9C27B0; }
        
        .kpi-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-title-dashboard {
            color: white;
            font-size: 1.8rem;
            margin: 30px 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .orden-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .orden-imagen-preview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            border: 3px solid #2196F3;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .orden-imagen-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .orden-header-content {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .orden-info-text {
            flex: 1;
        }

        .orden-detalles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .detalle-item-dashboard {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detalle-label-dashboard {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        .detalle-value-dashboard {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }
        
        .orden-card:hover {
            transform: translateY(-5px);
        }
        
        .orden-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .orden-numero {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
        }
        
        .orden-cliente {
            font-size: 1.2rem;
            color: #333;
        }
        
        .proceso-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .proceso-item {
            text-align: center;
            padding: 15px 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .proceso-item.pendiente {
            background: #ffebee;
            border: 2px solid #f44336;
        }
        
        .proceso-item.en-proceso {
            background: #fff3e0;
            border: 2px solid #FF9800;
        }
        
        .proceso-item.completado {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
        }
        
        .proceso-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .proceso-item.pendiente .proceso-icon { color: #f44336; }
        .proceso-item.en-proceso .proceso-icon { color: #FF9800; }
        .proceso-item.completado .proceso-icon { color: #4CAF50; }
        
        .proceso-nombre {
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
        }
        
        .proceso-estado {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }
        
        .orden-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
        
        .orden-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            color: #4CAF50;
            animation: pulse 2s infinite;
            z-index: 1000;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 15px;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }
        

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .login-error {
            color: #f44336;
            margin-top: 10px;
            font-weight: 600;
            display: none;
        }

        .login-logo {
            width: 100px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
        <!-- LOGIN OVERLAY -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <img src="logo.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
            <h2>Dashboard del Jefe</h2>
            <p>Ingrese la clave de acceso</p>
            <input type="password" id="loginPassword" class="login-input" placeholder="Clave de acceso" autofocus>
            <button class="btn btn-primary" onclick="verificarLogin()" style="width: 100%; padding: 15px;">
                <i class="fas fa-sign-in-alt"></i> Ingresar
            </button>
            <p class="login-error" id="loginError">‚ùå Clave incorrecta</p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <a href="index.html" style="color: #2196F3; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> Volver al inicio
                </a>
            </div>
        </div>
    </div>
    <div class="container dashboard-container">
        <header class="header">
            <div class="logo">
                <img src="logo.png" alt="Logo" style="height: 60px;" onerror="this.style.display='none'">
            </div>
            <h1>REG MARKETING</h1>
            <div class="company-name">S.A.S</div>
            <p>Dashboard de Producci√≥n en Tiempo Real</p>
        </header>

        <!-- KPIs PRINCIPALES -->
        <div class="kpi-stats">
            <div class="kpi-box blue">
                <div class="kpi-label">√ìrdenes Activas</div>
                <div class="kpi-value" id="totalOrdenes">0</div>
            </div>
            <div class="kpi-box orange">
                <div class="kpi-label">En Proceso</div>
                <div class="kpi-value" id="enProceso">0</div>
            </div>
            <div class="kpi-box green">
                <div class="kpi-label">Completadas</div>
                <div class="kpi-value" id="completadas">0</div>
            </div>
            <div class="kpi-box purple">
                <div class="kpi-label">Pendientes</div>
                <div class="kpi-value" id="pendientes">0</div>
            </div>
        </div>

        <!-- √ìRDENES DE PRODUCCI√ìN -->
        <h2 class="section-title-dashboard">
            <i class="fas fa-clipboard-list"></i>
            √ìrdenes de Producci√≥n
        </h2>
        <div id="listaOrdenes"></div>

        <!-- NAVEGACI√ìN -->
        <!-- BOTONES DE NAVEGACI√ìN MEJORADOS -->
        <!-- FOOTER CON NAVEGACI√ìN -->
        <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 1000;">
            <div style="max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                <a href="crear-orden.html" class="btn btn-primary" style="text-decoration: none; padding: 12px 20px;">
                    <i class="fas fa-plus-circle"></i> Nueva Orden
                </a>
                
                <a href="tablet-areas.html" class="btn btn-success" style="text-decoration: none; padding: 12px 20px;">
                    <i class="fas fa-tablet-alt"></i> Tablets
                </a>
                
                <button class="btn" onclick="verHistorial()" style="background: #9C27B0; color: white; padding: 12px 20px;">
                    <i class="fas fa-history"></i> Historial
                </button>
                
                <a href="index.html" class="btn btn-secondary" style="text-decoration: none; padding: 12px 20px;">
                    <i class="fas fa-home"></i> Inicio
                </a>
                
                <button class="btn btn-danger" onclick="cerrarSesion()" style="padding: 12px 20px;">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </div>

    <!-- INDICADOR DE AUTO-REFRESH -->
    <div class="auto-refresh">
        <i class="fas fa-sync-alt"></i> Actualizaci√≥n autom√°tica
    </div>

    <script>
        async function cargarOrdenes() {
            // Intentar cargar de Supabase primero
            let ordenes = await window.DB.obtenerOrdenes();

            // Si no hay conexi√≥n o falla, usar localStorage
            if (!ordenes || ordenes.length === 0) {
                ordenes = JSON.parse(localStorage.getItem('ordenes') || '[]');
            }
            const listaOrdenes = document.getElementById('listaOrdenes');
            
            if (ordenes.length === 0) {
                listaOrdenes.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No hay √≥rdenes de producci√≥n</h3>
                        <p>Crea la primera orden desde el formulario</p>
                        <a href="crear-orden.html" class="btn btn-primary" style="margin-top: 20px; text-decoration: none;">
                            <i class="fas fa-plus"></i> Crear Primera Orden
                        </a>
                    </div>
                `;
                actualizarEstadisticas(0, 0, 0, 0);
                return;
            }

            // Calcular estad√≠sticas
            let totalOrdenes = ordenes.length;
            let enProceso = 0;
            let completadas = 0;
            let pendientes = 0;

            ordenes.forEach(orden => {
                const estados = Object.values(orden.estado);
                const todasCompletadas = estados.every(e => e === 'completado');
                const algunaEnProceso = estados.some(e => e === 'en-proceso');
                const todasPendientes = estados.every(e => e === 'pendiente');

                if (todasCompletadas) {
                    completadas++;
                } else if (algunaEnProceso) {
                    enProceso++;
                } else if (todasPendientes) {
                    pendientes++;
                }
            });

            actualizarEstadisticas(totalOrdenes, enProceso, completadas, pendientes);

            // Generar HTML de √≥rdenes
            listaOrdenes.innerHTML = ordenes.map(orden => {
                const totalPrendas = Object.values(orden.tallas).reduce((sum, val) => sum + val, 0);
                const fechaEntrega = new Date(orden.fechaEntrega).toLocaleDateString('es-ES');
                return `
                    <div class="orden-card" style="cursor: pointer;" onclick="verOrdenCompleta('${orden.numeroOrden}')">
                        <div class="orden-header">
                            <div>
                                <div class="orden-numero">${orden.numeroOrden}</div>
                                <div class="orden-cliente">${orden.cliente}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: #666;">
                                    <i class="fas fa-calendar"></i> ${fechaEntrega}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                    <i class="fas fa-tshirt"></i> ${totalPrendas} prendas
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); verOrdenCompleta('${orden.numeroOrden}')" style="padding: 8px 12px; font-size: 0.85rem;">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-success btn-small" onclick="event.stopPropagation(); editarOrden('${orden.numeroOrden}')" style="padding: 8px 12px; font-size: 0.85rem;">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); eliminarOrden('${orden.numeroOrden}')" style="padding: 8px 12px; font-size: 0.85rem;">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="orden-info">
                            <div class="orden-info-item">
                                <i class="fas fa-tag"></i>
                                <span>${orden.tipoPrenda}</span>
                            </div>
                            <div class="orden-info-item">
                                <i class="fas fa-circle-notch"></i>
                                <span>${orden.cuello}</span>
                            </div>
                            ${orden.tela ? `
                                <div class="orden-info-item">
                                    <i class="fas fa-scroll"></i>
                                    <span>${orden.tela}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="proceso-grid">
                            ${generarProceso('Corte', 'cut', orden.estado.corte)}
                            ${generarProceso('Confecci√≥n', 'tshirt', orden.estado.confeccion)}
                            ${generarProceso('Impresi√≥n', 'print', orden.estado.impresion)}
                            ${generarProceso('Sublimaci√≥n', 'fill-drip', orden.estado.sublimacion)}
                            ${generarProceso('Despacho', 'shipping-fast', orden.estado.despacho)}
                        </div>
                    </div>
                `;
                
            }).join('');
        }

        function generarProceso(nombre, icon, estado) {
            const estadosTexto = {
                'pendiente': 'Pendiente',
                'en-proceso': 'En Proceso',
                'completado': 'Completado'
            };

            return `
                <div class="proceso-item ${estado}">
                    <div class="proceso-icon">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="proceso-nombre">${nombre}</div>
                    <div class="proceso-estado">${estadosTexto[estado]}</div>
                </div>
            `;
        }

        function actualizarEstadisticas(total, proceso, completas, pend) {
            document.getElementById('totalOrdenes').textContent = total;
            document.getElementById('enProceso').textContent = proceso;
            document.getElementById('completadas').textContent = completas;
            document.getElementById('pendientes').textContent = pend;
        }

        // Cargar al inicio
        cargarOrdenes();

        // Auto-refresh cada 5 segundos
        setInterval(cargarOrdenes, 5000);

        // Notificaci√≥n inicial
        setTimeout(() => {
            const notif = document.createElement('div');
            notif.className = 'notification info';
            notif.innerHTML = '<i class="fas fa-info-circle"></i> Dashboard en tiempo real activado';
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }, 500);
        function verOrdenCompleta(numeroOrden) {
            window.location.href = `ver-orden.html?orden=${numeroOrden}`;
        }
        // ===== SISTEMA DE LOGIN =====
        const CLAVE_JEFE = 'jefe2025'; // Cambiar aqu√≠ la clave

        function verificarLogin() {
            const password = document.getElementById('loginPassword').value;
            
            if (password === CLAVE_JEFE) {
                // Login correcto
                localStorage.setItem('jefeAutenticado', 'true');
                document.getElementById('loginOverlay').style.display = 'none';
                mostrarNotificacion('‚úÖ Acceso concedido', 'success');
            } else {
                // Login incorrecto
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
                
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }

        // Permitir Enter para login
        document.addEventListener('DOMContentLoaded', function() {
            const loginInput = document.getElementById('loginPassword');
            if (loginInput) {
                loginInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verificarLogin();
                    }
                });
            }
            
            // Verificar si ya est√° autenticado
            const autenticado = localStorage.getItem('jefeAutenticado');
            if (autenticado === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
            }
        });

        // Bot√≥n de cerrar sesi√≥n (opcional)
        function cerrarSesion() {
            localStorage.removeItem('jefeAutenticado');
            window.location.reload();
        }
        
        function verHistorial() {
            console.log('üîç Abriendo historial...');
            
            const historial = JSON.parse(localStorage.getItem('historialOrdenes') || '[]');
            console.log('üìã √ìrdenes en historial:', historial);
            
            if (historial.length === 0) {
                // Modal bonito cuando no hay historial
                const modalVacio = document.createElement('div');
                modalVacio.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                modalVacio.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <i class="fas fa-inbox" style="font-size: 5rem; color: #95a5a6; margin-bottom: 20px;"></i>
                        <h2 style="color: #2c3e50; margin-bottom: 15px;">Historial Vac√≠o</h2>
                        <p style="color: #7f8c8d; font-size: 1.1rem; margin-bottom: 30px;">
                            No hay √≥rdenes completadas en el historial a√∫n.
                        </p>
                        <button id="cerrarModalVacio" class="btn btn-primary" style="padding: 12px 30px;">
                            <i class="fas fa-check"></i> Entendido
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modalVacio);
                
                document.getElementById('cerrarModalVacio').onclick = () => {
                    modalVacio.remove();
                };
                
                // Cerrar al hacer clic fuera
                modalVacio.onclick = (e) => {
                    if (e.target === modalVacio) {
                        modalVacio.remove();
                    }
                };
                
                return;
            }

            // Crear modal para mostrar historial
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                overflow: auto;
                padding: 20px;
            `;
            
            let historialHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 3px solid #2980b9;">
                        <h2 style="color: #2c3e50; margin: 0;">
                            <i class="fas fa-history"></i> Historial de √ìrdenes Completadas
                        </h2>
                        <button id="cerrarHistorial" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                        <button id="generarReportePDF" class="btn btn-success" style="padding: 10px 20px;">
                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                        </button>
                        <button id="limpiarHistorial" class="btn btn-danger" style="padding: 10px 20px;">
                            <i class="fas fa-trash-alt"></i> Limpiar Historial
                        </button>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
            `;
            
            historial.forEach(orden => {
                const fecha = new Date(orden.fechaCompletado || orden.fechaCreacion);
                historialHTML += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #28a745;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <strong style="color: #666;">Orden:</strong> ${orden.numeroOrden}<br>
                                <strong style="color: #666;">Cliente:</strong> ${orden.cliente}<br>
                                <strong style="color: #666;">Prenda:</strong> ${orden.tipoPrenda}
                            </div>
                            <div>
                                <strong style="color: #666;">Total:</strong> ${orden.total} unidades<br>
                                <strong style="color: #666;">Completada:</strong> ${fecha.toLocaleDateString()}<br>
                                <strong style="color: #666;">Hora:</strong> ${fecha.toLocaleTimeString()}
                            </div>
                            <div style="text-align: right;">
                                <button class="btn btn-primary btn-small" onclick='verOrdenCompletaHistorial(${JSON.stringify(orden).replace(/'/g, "&#39;")})'>
                                    <i class="fas fa-eye"></i> Ver Detalles
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historialHTML += `
                    </div>
                </div>
            `;
            
            modal.innerHTML = historialHTML;
            document.body.appendChild(modal);
            
            document.getElementById('cerrarHistorial').onclick = () => {
                modal.remove();
            };
            
            // Cerrar al hacer clic fuera del modal
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            // Bot√≥n limpiar historial
            document.getElementById('limpiarHistorial').onclick = async () => {
                const confirmar = await mostrarModalConfirmacion(
                    '¬øEst√°s seguro?',
                    'Se eliminar√°n TODAS las √≥rdenes del historial. Esta acci√≥n no se puede deshacer.',
                    'Cancelar',
                    'S√≠, Limpiar Todo'
                );
                
                if (confirmar) {
                    try {
                        // Limpiar en Supabase
                        await window.DB.limpiarHistorial();
                        
                        // Limpiar en localStorage
                        localStorage.removeItem('historialOrdenes');
                        
                        modal.remove();
                        
                        // Notificaci√≥n toast bonita
                        const toast = document.createElement('div');
                        toast.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #27ae60;
                            color: white;
                            padding: 15px 25px;
                            border-radius: 10px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            z-index: 999999;
                            font-size: 16px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        `;
                        toast.innerHTML = '<i class="fas fa-check-circle"></i> Historial limpiado correctamente';
                        document.body.appendChild(toast);
                        
                        setTimeout(() => {
                            toast.style.opacity = '0';
                            toast.style.transition = 'opacity 0.3s';
                            setTimeout(() => toast.remove(), 300);
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Error limpiando historial:', error);
                        
                        // Toast de error
                        const toastError = document.createElement('div');
                        toastError.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #e74c3c;
                            color: white;
                            padding: 15px 25px;
                            border-radius: 10px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            z-index: 999999;
                            font-size: 16px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        `;
                        toastError.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al limpiar el historial';
                        document.body.appendChild(toastError);
                        
                        setTimeout(() => {
                            toastError.style.opacity = '0';
                            toastError.style.transition = 'opacity 0.3s';
                            setTimeout(() => toastError.remove(), 300);
                        }, 3000);
                    }
                }
            };

            // Bot√≥n generar reporte PDF
            document.getElementById('generarReportePDF').onclick = () => {
                console.log('üîç Bot√≥n PDF clickeado');
                console.log('üìä Historial a procesar:', historial);
                console.log('üì¶ jsPDF disponible?', typeof window.jspdf);
                
                try {
                    generarReporteMensualPDF(historial);
                    console.log('‚úÖ Funci√≥n ejecutada sin errores');
                } catch (error) {
                    console.error('‚ùå Error al generar PDF:', error);
                    alert('Error al generar PDF: ' + error.message);
                }
            };
        }

        // Funci√≥n para ver detalles de orden del historial
        function verOrdenCompletaHistorial(orden) {
            console.log('Ver orden del historial:', orden);
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                overflow: auto;
                padding: 20px;
            `;
            
            let tallasHTML = '';
            for (let [talla, cantidad] of Object.entries(orden.tallas || {})) {
                if (cantidad > 0) {
                    tallasHTML += `<span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; margin: 5px;">${talla}: ${cantidad}</span>`;
                }
            }
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; width: 100%;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #28a745; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ORDEN COMPLETADA
                        </h2>
                        <h3 style="color: #333;">${orden.numeroOrden}</h3>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #666; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Informaci√≥n General</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Cliente:</strong> ${orden.cliente}</div>
                            <div><strong>Tipo de Prenda:</strong> ${orden.tipoPrenda}</div>
                            <div><strong>Tipo de Cuello:</strong> ${orden.tipoCuello || 'N/A'}</div>
                            <div><strong>Marquilla:</strong> ${orden.marquilla || 'N/A'}</div>
                            <div><strong>Total Unidades:</strong> ${orden.total}</div>
                            <div><strong>Fecha Completado:</strong> ${new Date(orden.fechaCompletado || orden.fechaCreacion).toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #666; margin-bottom: 15px;"><i class="fas fa-ruler"></i> Tallas</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${tallasHTML}
                        </div>
                    </div>
                    
                    ${orden.disenoUrl ? `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                        <h4 style="color: #666; margin-bottom: 15px;"><i class="fas fa-image"></i> Dise√±o</h4>
                        <img src="${orden.disenoUrl}" style="max-width: 100%; max-height: 400px; border-radius: 10px;" />
                    </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="cerrarDetalleHistorial" class="btn btn-secondary" style="padding: 12px 30px;">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('cerrarDetalleHistorial').onclick = () => {
                modal.remove();
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function exportarHistorial() {
            const historial = JSON.parse(localStorage.getItem('historialOrdenes') || '[]');
            
            if (historial.length === 0) {
                // Modal bonito cuando no hay historial
                const modalVacio = document.createElement('div');
                modalVacio.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                modalVacio.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <i class="fas fa-inbox" style="font-size: 5rem; color: #95a5a6; margin-bottom: 20px;"></i>
                        <h2 style="color: #2c3e50; margin-bottom: 15px;">Historial Vac√≠o</h2>
                        <p style="color: #7f8c8d; font-size: 1.1rem; margin-bottom: 30px;">
                            No hay √≥rdenes completadas en el historial a√∫n.
                        </p>
                        <button id="cerrarModalVacio" class="btn btn-primary" style="padding: 12px 30px;">
                            <i class="fas fa-check"></i> Entendido
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modalVacio);
                
                document.getElementById('cerrarModalVacio').onclick = () => {
                    modalVacio.remove();
                };
                
                // Cerrar al hacer clic fuera
                modalVacio.onclick = (e) => {
                    if (e.target === modalVacio) {
                        modalVacio.remove();
                    }
                };
                
                return;
            }
            
            const csv = [
                ['N√∫mero Orden', 'Cliente', 'Fecha Completado', 'Total Prendas', 'Tipo Prenda'].join(','),
                ...historial.map(orden => {
                    const total = Object.values(orden.tallas).reduce((sum, val) => sum + val, 0);
                    const fecha = new Date(orden.fechaCompletado).toLocaleDateString('es-ES');
                    return [
                        orden.numeroOrden,
                        orden.cliente,
                        fecha,
                        total,
                        orden.tipoPrenda
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historial_ordenes_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            

            mostrarNotificacion('‚úÖ Historial exportado', 'success');
        }

        function ampliarImagen(imagenSrc) {
        const modal = document.createElement('div');
        modal.id = 'modalImagenAmpliada';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            cursor: zoom-out;
        `;
        
        const contenedor = document.createElement('div');
        contenedor.style.cssText = 'position: relative;';
        
        const img = document.createElement('img');
        img.src = imagenSrc;
        img.style.cssText = 'max-width: 90vw; max-height: 90vh; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);';
        
        const btnCerrar = document.createElement('button');
        btnCerrar.textContent = '‚úï';
        btnCerrar.style.cssText = `
            position: absolute;
            top: -20px;
            right: -20px;
            background: #f44336;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.5);
            transition: all 0.3s ease;
        `;
        
        btnCerrar.onmouseover = () => { btnCerrar.style.transform = 'scale(1.1)'; };
        btnCerrar.onmouseout = () => { btnCerrar.style.transform = 'scale(1)'; };
        
        btnCerrar.addEventListener('click', function(e) {
            e.stopPropagation();
            modal.remove();
        });
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        contenedor.appendChild(img);
        contenedor.appendChild(btnCerrar);
        modal.appendChild(contenedor);
        document.body.appendChild(modal);
    }

    function mostrarNotificacion(mensaje, tipo) {
        const notif = document.createElement('div');
        notif.className = `notification ${tipo}`;
        notif.textContent = mensaje;
        document.body.appendChild(notif);
        
        setTimeout(() => {
            notif.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notif.remove(), 300);
        }, 3000);
    }
    async function limpiarHistorial() {
        if (!confirm('‚ö†Ô∏è ¬øEst√°s SEGURO de eliminar TODO el historial?\n\nEsta acci√≥n NO se puede deshacer.')) {
            return;
        }
        
        if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\nSe eliminar√°n TODAS las √≥rdenes completadas.\n¬øContinuar?')) {
            return;
        }
        
        try {
            // Limpiar localStorage
            localStorage.removeItem('historialOrdenes');
            
            mostrarNotificacion('üóëÔ∏è Historial limpiado correctamente', 'success');
            
            // Cerrar modal
            document.querySelector('.modal-overlay')?.remove();
            
        } catch (error) {
            console.error('Error al limpiar historial:', error);
            mostrarNotificacion('‚ùå Error al limpiar historial', 'error');
        }
    }
    async function eliminarOrden(numeroOrden) {
        // Modal bonito
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <i class="fas fa-trash-alt" style="font-size: 4rem; color: #f44336; margin-bottom: 20px;"></i>
                <h2 style="color: #333; margin-bottom: 15px;">¬øEliminar la orden ${numeroOrden}?</h2>
                <p style="color: #666; font-size: 1.1rem; margin-bottom: 30px;">
                    Esta acci√≥n <strong>NO se puede deshacer</strong>
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="btnCancelar" class="btn btn-secondary" style="padding: 12px 30px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button id="btnEliminar" class="btn btn-danger" style="padding: 12px 30px;">
                        <i class="fas fa-trash"></i> S√≠, Eliminar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const respuesta = await new Promise(resolve => {
            document.getElementById('btnCancelar').onclick = () => {
                modal.remove();
                resolve(false);
            };
            document.getElementById('btnEliminar').onclick = () => {
                modal.remove();
                resolve(true);
            };
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    resolve(false);
                }
            };
        });
        
        if (!respuesta) return;
        
        try {
            // Eliminar de Supabase
            const resultado = await window.DB.eliminarOrden(numeroOrden);
            
            if (resultado.success) {
                // Tambi√©n eliminar de localStorage
                let ordenes = JSON.parse(localStorage.getItem('ordenes') || '[]');
                ordenes = ordenes.filter(o => o.numeroOrden !== numeroOrden);
                localStorage.setItem('ordenes', JSON.stringify(ordenes));
                
                mostrarNotificacion(`üóëÔ∏è Orden ${numeroOrden} eliminada`, 'success');
                cargarOrdenes();
            } else {
                throw new Error(resultado.error);
            }
        } catch (error) {
            console.error('Error al eliminar:', error);
            mostrarNotificacion('‚ùå Error al eliminar orden', 'error');
        }
    }
    function editarOrden(numeroOrden) {
        window.location.href = `crear-orden.html?editar=${numeroOrden}`;
    }

    function generarReporteMensualPDF(historial) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Colores corporativos
            const azulOscuro = [41, 128, 185];
            
            // Fecha actual
            const hoy = new Date();
            const mesActual = hoy.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            
            // Filtrar √≥rdenes del mes actual Y validar datos
            const ordenesDelMes = historial.filter(orden => {
                const fecha = new Date(orden.fechaCompletado || orden.fechaCreacion);
                return fecha.getMonth() === hoy.getMonth() && 
                    fecha.getFullYear() === hoy.getFullYear();
            }).map(orden => {
                // Asegurar que todos los campos tengan valores v√°lidos
                return {
                    ...orden,
                    total: orden.total || 0,
                    numeroOrden: orden.numeroOrden || 'N/A',
                    cliente: orden.cliente || 'N/A',
                    tipoPrenda: orden.tipoPrenda || 'N/A'
                };
            });
            
            if (ordenesDelMes.length === 0) {
                alert('No hay √≥rdenes completadas en el mes actual para generar el reporte.');
                return;
            }
            
            // ==========================================
            // ENCABEZADO
            // ==========================================

            // Rect√°ngulo azul en el encabezado
            doc.setFillColor(...azulOscuro);
            doc.rect(0, 0, 210, 50, 'F');

            // C√≠rculo blanco detr√°s del logo
            doc.setFillColor(255, 255, 255);
            doc.circle(30, 25, 18, 'F'); // x=30, y=25, radio=18

            // Logo encima del c√≠rculo blanco
            try {
                const img = new Image();
                img.src = 'logo.png';
                if (img.complete) {
                    doc.addImage(img, 'PNG', 15, 10, 30, 30);
                }
            } catch (error) {
                console.log('Logo no cargado');
            }

            // T√≠tulo principal
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('REG MARKETING S.A.S', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text('REPORTE MENSUAL DE PRODUCCI√ìN', 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(mesActual.toUpperCase(), 105, 40, { align: 'center' });
            
            // ==========================================
            // RESUMEN EJECUTIVO
            // ==========================================
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN EJECUTIVO', 15, 60);
            
            // Calcular estad√≠sticas
            const totalUnidades = ordenesDelMes.reduce((sum, orden) => sum + (parseInt(orden.total) || 0), 0);
            const promedio = ordenesDelMes.length > 0 ? Math.round(totalUnidades / ordenesDelMes.length) : 0;
            
            // Cuadro 1: Total de √≥rdenes
            doc.setFillColor(52, 152, 219);
            doc.roundedRect(15, 68, 58, 25, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('√ìrdenes Completadas', 44, 75, { align: 'center' });
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(ordenesDelMes.length.toString(), 44, 87, { align: 'center' });
            
            // Cuadro 2: Total de unidades
            doc.setFillColor(46, 204, 113);
            doc.roundedRect(78, 68, 58, 25, 3, 3, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Unidades Producidas', 107, 75, { align: 'center' });
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(totalUnidades.toString(), 107, 87, { align: 'center' });
            
            // Cuadro 3: Promedio por orden
            doc.setFillColor(155, 89, 182);
            doc.roundedRect(141, 68, 58, 25, 3, 3, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Promedio por Orden', 170, 75, { align: 'center' });
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(promedio.toString(), 170, 87, { align: 'center' });
            
            // ==========================================
            // TABLA DE √ìRDENES
            // ==========================================
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.text('DETALLE DE √ìRDENES', 15, 105);
            
            const tableData = ordenesDelMes.map(orden => {
                const fecha = new Date(orden.fechaCompletado || orden.fechaCreacion);
                return [
                    orden.numeroOrden,
                    orden.cliente,
                    orden.tipoPrenda,
                    (parseInt(orden.total) || 0).toString(),
                    fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })
                ];
            });
            
            doc.autoTable({
                startY: 110,
                head: [['N¬∞ Orden', 'Cliente', 'Tipo de Prenda', 'Unidades', 'Fecha']],
                body: tableData,
                theme: 'striped',
                headStyles: { 
                    fillColor: azulOscuro,
                    fontSize: 11,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                styles: { 
                    fontSize: 10,
                    cellPadding: 5
                },
                columnStyles: {
                    0: { halign: 'center', fontStyle: 'bold' },
                    3: { halign: 'center' },
                    4: { halign: 'center' }
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                }
            });
            
            // ==========================================
            // PIE DE P√ÅGINA
            // ==========================================
            
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // L√≠nea decorativa
                doc.setDrawColor(...azulOscuro);
                doc.setLineWidth(0.5);
                doc.line(15, doc.internal.pageSize.height - 20, 195, doc.internal.pageSize.height - 20);
                
                // Informaci√≥n del pie
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                doc.text(
                    `Generado: ${hoy.toLocaleDateString('es-ES')} ${hoy.toLocaleTimeString('es-ES')}`,
                    15,
                    doc.internal.pageSize.height - 12
                );
                doc.text(
                    `P√°gina ${i} de ${pageCount}`,
                    195,
                    doc.internal.pageSize.height - 12,
                    { align: 'right' }
                );
            }
            
            // ==========================================
            // GUARDAR PDF
            // ==========================================
            
            const nombreArchivo = `Reporte_${mesActual.replace(' ', '_')}.pdf`;
            doc.save(nombreArchivo);
            
            console.log('‚úÖ PDF generado exitosamente:', nombreArchivo);
            // Notificaci√≥n que no bloquea la descarga

            
        } catch (error) {
            console.error('‚ùå Error detallado al generar PDF:', error);
            alert('Error al generar PDF: ' + error.message);
        }
    }

    function mostrarModalConfirmacion(titulo, mensaje, textoNo, textoSi) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #f39c12; margin-bottom: 20px;"></i>
                    <h2 style="color: #333; margin-bottom: 15px;">${titulo}</h2>
                    <p style="color: #666; font-size: 1.1rem; margin-bottom: 30px;">${mensaje}</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="btnNo" class="btn btn-secondary" style="padding: 12px 30px;">
                            <i class="fas fa-times"></i> ${textoNo}
                        </button>
                        <button id="btnSi" class="btn btn-danger" style="padding: 12px 30px;">
                            <i class="fas fa-check"></i> ${textoSi}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('btnNo').onclick = () => {
                modal.remove();
                resolve(false);
            };
            
            document.getElementById('btnSi').onclick = () => {
                modal.remove();
                resolve(true);
            };
        });
    }
    </script>
</body>
</html>

